---
nt---
title: "Recreating garmin data viz in R"
author: "Micha≈Ç Wypych"
categories: [dataviz]
image: "image.png"
---

I recently got my first garmin watch and I'm fascinated by the dataviz aspect of it.

Making data visualizations that need to fir a circle with 40mm diameter is not something I've ever thought about before. So naturally I wanted to recreate them in #rstats.

## Visualizations I want to recreate

-   heart rate

    ![https://www.google.com/search?client=ubuntu-sn&hs=4Ao&sca_esv=b91b52423da4ab6e&channel=fs&sxsrf=ANbL-n6QYEk_CGKPhsnR4JY5V-z0BR0pHQ:1770235894954&udm=2&fbs=ADc_l-aTuuAJ5fCRiMSMSikFOrGF6bdyujK3KN_bbLSQcwMis3qSud1NYjsG0YQq1c8NN34BQtpZzsULWB4IaZevMKKeE15vwbQrlANlsnZkX69nqH7NyjC9x5AmHz1dhm9gmBNXMW6s6jKyP4AEYcLg41EqVT9td1oCG_S3eNjYZdVuNq9xyYQ94czUC2Qt7-Ta1dVwtjamRdLgTLVjpu1rwMY44T124zDVHavueKxtiZaW4IjLjVk&q=garmin+heart+rate+plot&sa=X&ved=2ahUKEwjtxb_N0sCSAxWzJBAIHXwwJkIQtKgLegQIERAB&biw=1854&bih=1083&dpr=1&aic=0#sv=CAMSVhoyKhBlLVFfZGlQVGJIZjI5cFlNMg5RX2RpUFRiSGYyOXBZTToOaV9HbW9MVzVfRjlsdE0gBCocCgZtb3NhaWMSEGUtUV9kaVBUYkhmMjlwWU0YADABGAcgicfesQ4wAkoKCAEQAhgCIAIoAg](images/paste-7.png)

<!-- -->

-   sleep

![https://www.google.com/url?sa=t&source=web&rct=j&url=https%3A%2F%2Fwww.garmin.com%2Fen-AU%2Fblog%2Fgarmin-sleep-score-and-sleep-insights%2F&ved=0CBYQjRxqFwoTCOjKxsTruJIDFQAAAAAdAAAAABBY&opi=89978449](images/paste-2.png)

-   str

    ![https://www.google.com/url?sa=t&source=web&rct=j&url=https%3A%2F%2Fwww8.garmin.com%2Fmanuals%2Fwebhelp%2FGUID-25E3235D-44D2-4384-A591-DD1D71BEBCB1%2FEN-US%2FGUID-9282196F-D969-404D-B678-F48A13D8D0CB.html&ved=0CBYQjRxqFwoTCNiO5LXsuJIDFQAAAAAdAAAAABAH&opi=89978449](images/paste-6.png)

    ess

![https://www.google.com/url?sa=t&source=web&rct=j&url=https%3A%2F%2Fwww.garmin.com.sg%2Fminisite%2Fwhy-garmin%2F&ved=0CBYQjRxqFwoTCMiF6K_ruJIDFQAAAAAdAAAAABAH&opi=89978449](images/paste-1.png)

-   some bar like training readiness

![https://www.google.com/url?sa=t&source=web&rct=j&url=https%3A%2F%2Fscandinavianoutdoor.com%2Fgarmin%2Fgear%2Fheart-rate-monitors-and-watches%2Fsports-watches%2Fforer-965-dlc-ti%2F&ved=0CBYQjRxqFwoTCMjvheDruJIDFQAAAAAdAAAAABA9&opi=89978449](images/paste-3.png){width="378"}

## Setup

-   packages I will use

    -   The dataviz will of course be in ggplot. For some of the effects I will need `{ggforce}`, `{ggtext}` and ...

-   some setup stuff like loading packages etc.

```{r}
library(ggplot2)
library(ggforce)
library(ggtext)
library(dplyr)
library(tidyr)
library(showtext)
```

## data

To recreate the plots of course we will need some data. This is the easy part since the data is pretty straightforward. For heart rate and stress data I can simulate from an arima process. Sleep plot and training readiness is just some categorical data.

```{r}

hr <- arima.sim(n = 480, list(ar = c(0.8897, -0.4858), ma = c(.9, .6)), sd = sqrt(1), mean = 22)

hr_data <- data.frame(time = 1:480,
                      hr = hr)


sleep_data <- data.frame(
    day = c(seq.Date(from = as.Date("2026-02-02"), length.out = 7, by = "day")),
    awake = c(0, 36, 10, 0, 0, 12, 5),
    light = c(237, 245, 210, 255, 232, 217, 220),
    deep = c(71, 72, 63, 85, 58, 50, 75),
    REM = c(93, 90, 83, 96, 71, 64, 78)
)

stress <- arima.sim(n = 68, list(ar = c(.9), ma = c(.9, .6, 12)), sd = .35, mean = .3)



stress_data <- data.frame(time = 1:68,
                          stress = stress)

stress_data <- stress_data |>
    mutate(level = case_when(
        stress <= 30 ~ "low",
        stress <= 50 ~ "med",
        stress <= 75 ~ "high",
        stress > 75 ~ "very high"
    ))

training_data <- data.frame(
    status = c("not ready", "no", "ok", "ready", "prime"),
    level = c(0.25, 0.25, 0.25, 0.22, 0.03)
)


```

## Making the vis

-   theme:

    Garmin has a dark-theme, with plenty of gradient.

```{r}
font <- "Noto Sans"
font_add_google(font)
showtext_auto()
theme_garmin <- function() {
    theme_minimal() +
    theme(plot.background = element_rect(fill = "#050505"),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text = element_text(color = "white", size = 15),
         text = element_text(color = "grey60", family = font))
}
```

### Sleep plot

-   making the plot

This plot is quite similar to the heart rate

```{r}
# making the grid lines
grid_line <- data.frame(
  x = c(min(sleep_data$day), median(sleep_data$day), max(sleep_data$day)),
  y = rep(c(10, 5), each = 3),
  alpha_val = rep(c(0.1, 1, 0.1), 2),
  line_id = rep(1:2, each = 3)
)
grid_line2 <- data.frame(
  x = c(min(sleep_data$day), median(sleep_data$day), max(sleep_data$day)),
  y = rep(c(7.5, 2.5), each = 3),
  alpha_val = rep(c(0.1, 1, 0.1), 2),
  line_id = rep(1:2, each = 3))
# main plot

sleep_data |>
    pivot_longer(cols = c(-day), names_to = "phase", values_to = "time") |>
    mutate(phase = factor(phase, ordered = TRUE, levels = c("awake", "REM", "light", "deep")),
           time = time / 60) |>
    ggplot() +
    geom_link2(data = grid_line, 
                   aes(x = x, y = y, alpha = alpha_val, group = line_id),
                   color = "white", n = 500) +
    geom_link2(data = grid_line2, 
                   aes(x = x, y = y, alpha = alpha_val, group = line_id),
                   color = "white", n = 500) +
    geom_col(aes(x = day, y = time, fill = phase), width = .5) +
    annotate(geom = "text", x = median(sleep_data$day), y = 11, label = "Sleep stages", family = font, size = 8, color = "grey60") +
    annotate(geom = "text", x = median(sleep_data$day), y = 11.9, label = "üí§", color = "blue", size = 10, color = "grey60") +
    scale_fill_manual(values = c("awake" = "#D5538E", "REM" = "#7209b7", "light" = "#42A6C4", "deep" = "#0B20A3")) +
    scale_x_date(date_breaks = "1 day", date_labels = "%a") +
    scale_y_continuous(breaks = c(5, 10), expand = c(0,0), position = "right") +
    coord_cartesian(ylim = c(0, 12.5)) +
    labs(x = NULL, y = NULL) + 
    theme_garmin() +
    theme(legend.position = "none",
         axis.line.x = element_line(color = "grey60"),
         axis.text.x = element_text(color = "grey60", family = font))
```

### Heart rate plot

-   making the plot

```{r}
grid_line <- data.frame(
  x = rep(c(0, max(hr_data$time)), 2),
  y = rep(c(100, 90), each = 2),
  alpha_val = rep(c(0.1, 1), 2),
  line_id = rep(1:2, each = 2)
)
grid_line2 <- data.frame(
  x = rep(c(0, max(hr_data$time)), 2),
  y = rep(c(95, 85), each = 2),
  alpha_val = rep(c(0.1, .5), 2),
  line_id = rep(1:2, each = 2)
)

hr_data |>
    ggplot(aes(x = time, y = hr)) + 
    geom_link2(data = grid_line, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
geom_link2(data = grid_line2, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
    scale_alpha_identity() +
    geom_line(color = "grey50") +
    geom_area(alpha = .4) +
    #add annotation for max and min
    annotate(geom = "text", x =hr_data[which.max(hr_data$hr), ]$time, y = max(hr_data$hr), label = round(max(hr_data$hr), 0), color = "grey90", size = 6, family = font) +
    annotate(geom = "text", x =hr_data[which.min(hr_data$hr), ]$time, y = min(hr_data$hr), label = round(min(hr_data$hr), 0), color = "grey90", size = 6
) +
    # add heart rate box part
    annotate(geom = "text", x =median(hr_data$time), y = max(hr_data$hr) * 1.1, label = round(mean(hr_data$hr), 0), color = "grey90", size = 20
) +
    annotate(geom = "text", x =median(hr_data$time), y = max(hr_data$hr) * 1.05, label = paste0("RHR ", 50), color = "grey60", size = 12
) +
annotate("text", x = 240, y = max(hr_data$hr) * 1.15, 
             label = "‚ù§", color = "red", size = 20) +
    scale_y_continuous(breaks = c(90, 100), position = "right") +    
coord_cartesian(ylim = c(80, 120)) +
scale_x_continuous(expand = c(0,0)) +
    labs(x = "Last 4 Hours", y = NULL) +
    theme_garmin() +
    theme(
        axis.line.x = element_line(color = "grey60"),
            axis.ticks.x = element_line(color = "grey60", linewidth = 1),
        axis.text.x = element_blank(),
        axis.title.x = element_text(size = 14, color = "grey60"),
        axis.ticks.length.x = unit(-.25, "cm")
    )
```

-   comparison

::: columns
:::

### Stress plot

-   making the plot

This plot is quite similar to the heart rate plot with the main difference being bars instead of lines.

```{r}

#get alpha grid lines
grid_line <- data.frame(
  x = rep(c(0, max(stress_data$time)), 2),
  y = rep(c(100, 50), each = 2),
  alpha_val = rep(c(0.1, 1), 2),
  line_id = rep(1:2, each = 2)
)
grid_line2 <- data.frame(
  x = rep(c(0, max(stress_data$time)), 2),
  y = rep(c(75, 25), each = 2),
  alpha_val = rep(c(0.1, .5), 2),
  line_id = rep(1:2, each = 2)
)


stress_plot <- stress_data |>
    ggplot() +
    #add alpha grid lines
    geom_link2(data = grid_line, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
geom_link2(data = grid_line2, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
    geom_link(aes(x = time, xend = time, y = 0, yend = stress, colour = level, alpha = after_stat(index)), n = 500, linewidth = 3.5) +
    #add the box
    annotate(geom = "text", x =median(stress_data$time), y = 115, label = 25, color = "grey90", size = 20
) +
    annotate(geom = "text", x =median(stress_data$time), y = 105, label = paste0("rest"), color = "grey60", size = 12
) +
annotate("text", x = median(stress_data$time), y = 127, 
             label = "üë§", color = "blue", size = 20) +
    scale_color_manual(values = c("low" = "blue", "med" = "#F8BB59", "high" = "#fb8b24", "very high" = "#6a040f")) +
scale_y_continuous(expand = c(0,0), breaks = c(50, 100), position = "right") +
coord_cartesian(ylim = c(0, 135)) +
scale_alpha_continuous(range = c(0, 1)) + 
labs(y = NULL, x = "Last 4 hours") +
    theme_garmin() +
    theme(legend.position = "none",
         axis.line.x = element_line(color = "grey60"),
            axis.ticks.x = element_line(color = "grey60", linewidth = 1),
        axis.text.x = element_blank(),
        axis.title.x = element_text(size = 14, color = "grey60"),
        axis.ticks.length.x = unit(-.25, "cm"),
         plot.margin = margin(200,200,200,200))
```

-   comparison

### Training plot

-   making the plot

This one is definitely the toughest one. The gauge part is easy enough with `coord_radial()` (full credit for such solution to Cedric Scherer!) but the gradient lines with background is really stretching ggplot abilities. If we needed just to add gradients then the `{ggforce}` with `geom_link2()` would work nicely. But with the coordinates set to radial makes things difficult

```{r}
#gradient arc data
#how can we add the gradients?

#we need some way to place the gradient background inside the plot
#and then the last thing to figure out - cropping to a circle

library(grid)
library(ggimage)

radius <- 1
n_lines <- 50

chord_data <- data.frame(
  y = seq(-radius, radius, length.out = n_lines)
) |>
  filter(abs(y) < radius) |>
  mutate(
    x_offset = sqrt(radius^2 - y^2),
    x_start = -x_offset,
    x_end = x_offset,
    angle = pi/4,
    line_id = row_number()
  ) |>
  rowwise() |>
  mutate(
    # Vary the peak position smoothly across lines
    peak_pos = 4 + sin((line_id / n_lines) * 2 * pi),  # Oscillates between 1 and 3
    # Create 5 points with peak at varying position
    x_points = list(seq(x_start, x_end, length.out = 5)),
    y_points = list(rep(y, 5)),
    # Generate alpha based on distance from peak_pos
    alpha_val = list(pmax(0.1, 1 - abs(1:5 - peak_pos) / 2))
  ) |>
  unnest(c(x_points, y_points, alpha_val)) |>
  mutate(
    x = x_points * cos(angle) - y_points * sin(angle),
    y_new = x_points * sin(angle) + y_points * cos(angle)
  )

gradient_background <- ggplot(chord_data) +
  geom_link2(aes(x = x, y = y_new, alpha = alpha_val, group = line_id), 
             color = "#72ddf7", n = 500) +
  scale_alpha_identity() +
  coord_fixed() +
  theme_void() +
  theme(panel.background = element_rect(fill = "black"))


temp_file <- tempfile(fileext = ".png")
ggsave(temp_file, gradient_background, width = 4, height = 4, bg = "transparent")

#final plot
training_plot <- ggplot() +
coord_radial(
    start = 4/3 * pi,  # 240¬∞
    end = 2/3 * pi,    # 120¬∞
    expand = FALSE,
    rlim = c(0, 1.2)
  ) +
    geom_image(aes(x = 5, y = 0, image = temp_file), size = .95) +
    annotate(
    geom = "rect", 
    xmin = c(0, 2.5, 5, 7.5, 9.7), xmax = c(2.5, 5, 7.5, 9.7, 10),
    ymin = c(.97, .97,.97, .93, .97), ymax = 1,
    fill = c("#d00000", "#ff9100", "#70e000", "#72ddf7", "purple")
  ) +
    annotate(
        geom = "segment", 
        x = c(2.5, 5, 7.5, 9.7), xend = c(2.5, 5, 7.5, 9.7), 
        y = .93, yend = 1,
        linewidth = 1, color = "#101010"
      ) +
    annotate(
        geom = "segment", 
        x = 8.2, xend = 8.2,
        y = .88, yend = 1.02,
        size = 2, linewidth = 2, color = "#101010"
      ) +
    annotate(
        geom = "segment", 
        x = 8.2, xend = 8.2,
        y = .9, yend = 1,
        size = 2, linewidth = 1, color = "grey90"
      ) +
    annotate(
        geom = "text",
        x = 5,
        y = .65,
        label = "Training\nreadiness",
        color = "white",
        fontface = "bold",
        family = font,
        lineheight = .3,
        size = 8
    ) +
    annotate(
        geom = "text",
        x = 5,
        y = 0.1,
        label = 82,
        color = "white",
        family = font,
        size = 30
    ) +
    geom_text(
        aes(x = 5,
        y = 0,
        label = "High"),
        color = "#72ddf7",
        family = font,
        fontface = "italic",
        nudge_y = -.4,
        size = 10
    ) +
    geom_text(
        aes(x = 5,
        y = 0,
        label = "Well Recovered"),
        color = "white",
        family = font,
        nudge_y = -.6,
        size = 8
    ) +
labs(x = NULL, y = NULL) +
    theme_garmin() +
    theme(axis.text = element_blank(),
         plot.margin = margin(b = 50))
```

```{r}
#saving as circle
library(magick)

crop_to_circle <- function(original_plot, width, height) {
    
    ggsave(temp_file, original_plot, width = width, height = height, bg = "black")
    
    img <- image_read(temp_file) |>
      image_scale("500x500") |>
      image_background("none") |>
      image_border("none", "0x0") |>
      image_trim()
    
    # Create circular mask
    mask <- image_draw(image_blank(500, 500))
    symbols(219, 220, circles = 150, bg = 'black', inches = FALSE, add = TRUE)
    dev.off()
    
    img_circle <- image_composite(img, mask, operator = "DstIn")
    return(img_circle)
}

# ok this works for training plot!
training_plot_final <- crop_to_circle(training_plot, 2, 2)
training_plot_final
```

-   comparison

## Final thoughts

-   what was fun?

-   What was tough?