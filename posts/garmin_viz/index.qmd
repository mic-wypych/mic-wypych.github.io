---
title: "Recreating garmin data viz in R"
date: "'r Sys.Date()'"
author: "Michał Wypych"
format:
  html:
    code-fold: true
    code-summary: "Show the code"
categories: [dataviz]
image: "image.png"
---

I recently got my first garmin watch and I'm fascinated by the dataviz aspect of it.

- what is garmin
- what are the visualizations about

Making data visualizations that need to fit a circle with 40mm diameter is not something I've ever thought about before. So naturally I wanted to recreate them in #rstats. Here are some examples of charts in garmin watches that I wnt to recreate.

Will I use it for anything? No. Is it fun? Hell yes! And I find recreating other data visualizations to be a great way to learn new techniques and improve your skills. Especially ones that were created in a different technology. I only have the end point and I need to figure out how to do it in R. That means my thinking is not naturally constrained by what is intuitive in R/ggplot world.


:::: {.columns}
::: {.column}
heart rate

![https://www.google.com/search?client=ubuntu-sn&hs=4Ao&sca_esv=b91b52423da4ab6e&channel=fs&sxsrf=ANbL-n6QYEk_CGKPhsnR4JY5V-z0BR0pHQ:1770235894954&udm=2&fbs=ADc_l-aTuuAJ5fCRiMSMSikFOrGF6bdyujK3KN_bbLSQcwMis3qSud1NYjsG0YQq1c8NN34BQtpZzsULWB4IaZevMKKeE15vwbQrlANlsnZkX69nqH7NyjC9x5AmHz1dhm9gmBNXMW6s6jKyP4AEYcLg41EqVT9td1oCG_S3eNjYZdVuNq9xyYQ94czUC2Qt7-Ta1dVwtjamRdLgTLVjpu1rwMY44T124zDVHavueKxtiZaW4IjLjVk&q=garmin+heart+rate+plot&sa=X&ved=2ahUKEwjtxb_N0sCSAxWzJBAIHXwwJkIQtKgLegQIERAB&biw=1854&bih=1083&dpr=1&aic=0#sv=CAMSVhoyKhBlLVFfZGlQVGJIZjI5cFlNMg5RX2RpUFRiSGYyOXBZTToOaV9HbW9MVzVfRjlsdE0gBCocCgZtb3NhaWMSEGUtUV9kaVBUYkhmMjlwWU0YADABGAcgicfesQ4wAkoKCAEQAhgCIAIoAg](images/paste-7.png)

sleep

![https://www.google.com/url?sa=t&source=web&rct=j&url=https%3A%2F%2Fwww.garmin.com%2Fen-AU%2Fblog%2Fgarmin-sleep-score-and-sleep-insights%2F&ved=0CBYQjRxqFwoTCOjKxsTruJIDFQAAAAAdAAAAABBY&opi=89978449](images/paste-2.png)

:::
::: {.column}
stress

![https://www.google.com/url?sa=t&source=web&rct=j&url=https%3A%2F%2Fwww.garmin.com.sg%2Fminisite%2Fwhy-garmin%2F&ved=0CBYQjRxqFwoTCMiF6K_ruJIDFQAAAAAdAAAAABAH&opi=89978449](images/paste-1.png)

some bar like training readiness

![https://www.google.com/url?sa=t&source=web&rct=j&url=https%3A%2F%2Fscandinavianoutdoor.com%2Fgarmin%2Fgear%2Fheart-rate-monitors-and-watches%2Fsports-watches%2Fforer-965-dlc-ti%2F&ved=0CBYQjRxqFwoTCMjvheDruJIDFQAAAAAdAAAAABA9&opi=89978449](images/paste-3.png){width="378"}
:::
<!-- end columns -->
::::

There are a few things that I think are pretty distinctive of garmin dataviz.

-   vivid, lively colors in a dark theme

-   Plenty of gradient/changes in transparency

-   using key highlights

All of those help to remove things that could distract users from the key elements and allow for more intuitive grasp. It's actually quite natural if you design charts that are supposed to be displayed on a 40mm screen that users will just glance at while walking/running. You can't get into any detailed stroytelling here!

## Setup

```{r setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

In order to recreate the garmin data viz we'll need a few sets of package. Firstly, of course some data wrangling and basic `{ggplot2}`. We'll need `{ggforce}` to better work with gradients and transparency in the plots. We'll also need some packages to deal with texts: `{showtext}` for basic font, `{fontawesome}` for icons and `{ggtext}` to work with those icons inside ggplot. Finally we'll need `{magick}` to crop the plots to circular shape and `{ggimage}` to place the gradient background in the trainind readiness plot.

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggforce)
library(ggtext)
library(showtext)
library(fontawesome)
library(magick)
```

## data

To recreate the plots of course we will need some data. This is the easy part since the data is pretty straightforward. For heart rate and stress data I can simulate from an arima process. Sleep plot and training readiness is just some categorical data. Heart rate and stress plots displays changes over time on a granular level while the sleep plot shows them on daily intervals. The training readiness plot just shows training readiness in a given moment.

```{r}
set.seed(2137)

hr_raw <- arima.sim(n = 480, list(ar = c(0.95), ma = c(0.3)), sd = 2)
hr <- 70 + hr_raw

hr_data <- data.frame(time = 1:480,
                      hr = hr)


sleep_data <- data.frame(
    day = c(seq.Date(from = as.Date("2026-02-02"), length.out = 7, by = "day")),
    awake = c(0, 36, 10, 0, 0, 12, 5),
    light = c(237, 245, 210, 275, 232, 217, 220),
    deep = c(71, 72, 63, 115, 58, 50, 75),
    REM = c(93, 90, 83, 102, 71, 64, 78)
)


stress <- arima.sim(n = 68, list(ar = c(.9), ma = c(.9, .6, 12)), sd = .55, mean = .3)

stress_data <- data.frame(time = 1:68,
                          stress = stress)

stress_data <- stress_data |>
    mutate(level = case_when(
        stress <= 30 ~ "low",
        stress <= 50 ~ "med",
        stress <= 75 ~ "high",
        stress > 75 ~ "very high"
    ))


training_data <- data.frame(
    status = c("not ready", "no", "ok", "ready", "prime"),
    level = c(0.25, 0.25, 0.25, 0.22, 0.03)
)


```

## Making the vis

We'll start making the visualizations by defining some common theme to use in all plots. Garmin plots use a dark-theme with gray, large text. We'll use Noto Sans as our base font and use icons from fontawesome. In order to recreate the plots you need to download the otf files from their website.

```{r}
font <- "Noto Sans"
font_add_google(font)
font_add('fa-solid', './Font Awesome 7 Free-Solid-900.otf')
# my guess is we need to adjust both the size of the original p
showtext_auto()
theme_garmin <- function() {
    theme_minimal() +
    theme(plot.background = element_rect(fill = "#050505"),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text = element_text(color = "white", size = 15),
         text = element_text(color = "grey60", family = font))
}
```

### Cropping to circle

Before me make the visualizations lets work out how to crop the plot to a circle. The main idea here is to save the plot to a temporary file, fix its size with some extra space around it. Then we draw a circle around the plot and crop it to that circle. The function allows us to control the width and height of the cropped plot which will come in handy when cropping different plots. We also need to control the scale of the image (mainly because the training readiness plot looks different and needs different scale) and where to place the circle mask as well as its size. Tweaking the parameters took quite a few iterations but once they are set it should be straightforward to crop our plots. Ultimately the size argument in circle_position is crucial for setting the size of the final plot and we want to keep it constant across the plots.

```{r}
crop_to_circle <- function(original_plot, width, scale, height, border, circle_position) {
    temp_file <- tempfile(fileext = ".png")
    ggsave(temp_file, original_plot, width = width, height = height, bg = "black")

  img <- image_read(temp_file) |>
      image_scale(paste0(scale, "x", scale)) |>
      image_background("none") |>
      image_border("none", paste0(border, "x", border)) |>
      image_trim()
    
    # Create circular mask
    mask <- image_draw(image_blank(scale, scale))
    symbols(circle_position["left"], circle_position["top"], circles = circle_position["size"], bg = 'black', inches = FALSE, add = TRUE)
    dev.off()
    
    img_circle <- image_composite(img, mask, operator = "DstIn")
    return(img_circle)
}
```

We can see how this works on a simple example:

```{r}


```

One thing that bit me with that approach was setting the right margins in the plots before cropping. Essentially we need to add enough space around the plot so that the cropped plot doesn't cut off any of the elements. This was especially tricky with the training readiness plot as it looked different from other plots.


### Sleep plot

Lets start with the sleep stages plot. The plot has pretty much 3 elements we need to build:

-   the grid lines that fade at the sides (some grid lines are brighter than others)

-   the text and icon at the top

-   the bars showing the data for each day of the week.

Lets start with the simplest part: bars. It's pretty much a standard bar chart with custom colors.

```{r}

```


`{ggplot}` doesn't allow us to use gradient on the grid lines so we need to make them manually. This is when `{ggforce}` comes to the rescue with its amazing `geom_link2()`. Honestly it's been the best function for me to work with gradients and lines in `{ggplot}`.



Finally we need to add the icon and the text about sleep stages. We can use `geom_richtext()` from `{ggtext}` to add the icon. The icon itself is just a unicode character from fontawesome package. Text can be added with `annotate()`.

```{r}
# making the grid lines
grid_line <- data.frame(
  x = c(min(sleep_data$day), median(sleep_data$day), max(sleep_data$day)),
  y = rep(c(10, 5), each = 3),
  alpha_val = rep(c(0.1, 1, 0.1), 2),
  line_id = rep(1:2, each = 3)
)
grid_line2 <- data.frame(
  x = c(min(sleep_data$day), median(sleep_data$day), max(sleep_data$day)),
  y = rep(c(7.5, 2.5), each = 3),
  alpha_val = rep(c(0.1, 1, 0.1), 2),
  line_id = rep(1:2, each = 3))
# main plot

sleep_plot <- sleep_data |>
    pivot_longer(cols = c(-day), names_to = "phase", values_to = "time") |>
    mutate(phase = factor(phase, ordered = TRUE, levels = c("awake", "REM", "light", "deep")),
           time = time / 60) |>
    ggplot() +
    geom_link2(data = grid_line, 
                   aes(x = x, y = y, alpha = alpha_val, group = line_id),
                   color = "white", n = 500) +
    geom_link2(data = grid_line2, 
                   aes(x = x, y = y, alpha = alpha_val, group = line_id),
                   color = "white", n = 500) +
    geom_col(aes(x = day, y = time, fill = phase), width = .5) +
    annotate(geom = "text", x = median(sleep_data$day), y = 11, label = "Sleep stages", family = font, size = 50, color = "grey60") +
    geom_richtext(aes(x = median(sleep_data$day), y = 12.3, label = "<span style='font-family:fa-solid'>&#xf186;</span>"), text.color = "blue", size = 75, fill = NA) +
    scale_fill_manual(values = c("awake" = "#D5538E", "REM" = "#7209b7", "light" = "#42A6C4", "deep" = "#0B20A3")) +
    scale_x_date(date_breaks = "1 day", labels = function(x) substr(format(x, "%a"), 1, 1)) +
    scale_y_continuous(breaks = c(5, 10), expand = c(0,0), position = "right") +
    coord_cartesian(ylim = c(0, 13.5)) +
    labs(x = NULL, y = NULL) + 
    theme_garmin() +
    theme(legend.position = "none",
        axis.line.x = element_line(color = "grey60"),
            axis.ticks.x = element_line(color = "grey60", linewidth = 1),
        axis.text = element_text(color = "grey60", size = 120),
        axis.title.x = element_text(size = 100, color = "grey60"),
        axis.ticks.length.x = unit(-.25, "cm"),
         plot.margin = margin(t = 50,200,200,200))

cropped_sleep_plot <- crop_to_circle(sleep_plot, 12.5, 12.5, border = 10, scale = 500, c("left" = 240, "top" = 220, "size" = 220))
cropped_sleep_plot
```

### Heart rate plot

This plot shows changes in heart rate over time (a couple of hours).

```{r}

median_hr <- round(median(hr), -1)

grid_line <- data.frame(
  x = rep(c(0, max(hr_data$time)), 2),
  y = rep(c(100, median_hr), each = 2),
  alpha_val = rep(c(0.1, 1), 2),
  line_id = rep(1:2, each = 2)
)
grid_line2 <- data.frame(
  x = rep(c(0, max(hr_data$time)), 2),
  y = rep(c(100 - ((100 - median_hr)/2), median_hr - ((100 - median_hr)/2)), each = 2),
  alpha_val = rep(c(0.1, .5), 2),
  line_id = rep(1:2, each = 2)
)

heart_plot <- hr_data |>
    ggplot(aes(x = time, y = hr)) + 
    geom_link2(data = grid_line, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
geom_link2(data = grid_line2, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
    scale_alpha_identity() +
    geom_line(color = "grey80") +
    geom_area(alpha = .4, fill = "grey30") +
    #add annotation for max and min
    annotate(geom = "text", x =hr_data[which.max(hr_data$hr), ]$time, y = max(hr_data$hr), label = round(max(hr_data$hr), 0), color = "grey90", size = 30, family = font) +
    annotate(geom = "text", x =hr_data[which.min(hr_data$hr), ]$time, y = min(hr_data$hr), label = round(min(hr_data$hr), 0), color = "grey90", size = 30
) +
    # add heart rate box part
    annotate(geom = "text", x =median(hr_data$time), y = 110, label = round(mean(hr_data$hr), 0), color = "grey90", size = 80
) +
    annotate(geom = "text", x =median(hr_data$time), y = 105, label = paste0("RHR ", 50), color = "grey60", size = 50
) +
geom_richtext(aes(x = 240, y = 118, label = "<span style='font-family:fa-solid'>&#xf004;</span>"), text.color = "red", size = 90, fill = NA) +
scale_x_continuous(expand = c(0,0)) +
    scale_y_continuous(breaks = c(round(median_hr, -1), 100), position = "right") +    
coord_cartesian(ylim = c(median_hr - (100 - median_hr)/2, 120)) +
scale_x_continuous(expand = c(0,0)) +
    labs(x = "Last 4 Hours", y = NULL) +
    theme_garmin() +
    theme(
        axis.line.x = element_line(color = "grey60"),
            axis.ticks.x = element_line(color = "grey60", linewidth = 1),
        axis.text.y = element_text(color = "grey60", size = 120),
        axis.text.x = element_blank(),
        axis.title.x = element_text(size = 100, color = "grey60"),
        axis.ticks.length.x = unit(-.25, "cm"),
         plot.margin = margin(t = 100,200,200,200)
    )

cropped_heart_plot <- crop_to_circle(heart_plot, 15, 15, border = 10,scale = 500, c("left" = 240, "top" = 220, "size" = 220))
cropped_heart_plot
```

### Stress plot

-   making the plot

This plot is quite similar to the heart rate plot with the main difference being bars instead of lines.

```{r}

#get alpha grid lines
grid_line <- data.frame(
  x = rep(c(0, max(stress_data$time)), 2),
  y = rep(c(100, 50), each = 2),
  alpha_val = rep(c(0.1, 1), 2),
  line_id = rep(1:2, each = 2)
)
grid_line2 <- data.frame(
  x = rep(c(0, max(stress_data$time)), 2),
  y = rep(c(75, 25), each = 2),
  alpha_val = rep(c(0.1, .5), 2),
  line_id = rep(1:2, each = 2)
)


stress_plot <- stress_data |>
    ggplot() +
    #add alpha grid lines
    geom_link2(data = grid_line, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
geom_link2(data = grid_line2, 
               aes(x = x, y = y, alpha = alpha_val, group = line_id),
               color = "white", n = 500) +
    geom_link(aes(x = time, xend = time, y = 0, yend = stress, colour = level, alpha = after_stat(index)), n = 500, linewidth = 3.5) +
    #add the box
    annotate(geom = "text", x =median(stress_data$time), y = 117, label = 25, color = "grey90", size = 80
) +
    annotate(geom = "text", x =median(stress_data$time), y = 105, label = paste0("rest"), color = "grey60", size = 50
) +
geom_richtext(aes(x = median(stress_data$time), y = 135, label = "<span style='font-family:fa-solid'>&#xf007;</span>"), text.color = "blue", size = 90, fill = NA) +
    scale_color_manual(values = c("low" = "blue", "med" = "#F8BB59", "high" = "#fb8b24", "very high" = "#bb3e03")) +
scale_x_continuous(expand = c(0,0)) +
scale_y_continuous(expand = c(0,0), breaks = c(50, 100), position = "right") +
coord_cartesian(ylim = c(0, 150), xlim = c(1, 68)) +
scale_alpha_continuous(range = c(0, 1)) + 
labs(y = NULL, x = "Last 4 hours") +
    theme_garmin() +
    theme(legend.position = "none",
         axis.line.x = element_line(color = "grey60"),
         axis.ticks.x = element_line(color = "grey60", linewidth = 1),
        axis.text.x = element_blank(),
        axis.text.y = element_text(color = "grey60", size = 120),
        axis.title.x = element_text(size = 100, color = "grey60"),
        axis.ticks.length.x = unit(-.25, "cm"),
         plot.margin = margin(t = 50,200,200,200))

cropped_stress_plot <- crop_to_circle(stress_plot, 15, 15, border = 10,scale = 500, c("left" = 240, "top" = 220, "size" = 220))
cropped_stress_plot
```

-   comparison

### Training plot

This one is definitely the toughest one. The gauge part is easy enough with `coord_radial()` (full credit for such solution to Cedric Scherer!) but the gradient lines with background is really stretching ggplot abilities. If we needed just to add gradients then the `{ggforce}` with `geom_link2()` would work nicely. But with the coordinates set to radial makes things difficult. Additionally the lines with gradient are all arcs of a cricle and they have different patterns to changing their transparency.\
I'm not gonna lie, part of the

Here's how it ultimately looks like:

```{r}

library(ggimage)

radius <- 1
n_lines <- 50

chord_data <- data.frame(
  y = seq(-radius, radius, length.out = n_lines)
) |>
  filter(abs(y) < radius) |>
  mutate(
    x_offset = sqrt(radius^2 - y^2),
    x_start = -x_offset,
    x_end = x_offset,
    angle = pi/4,
    line_id = row_number()
  ) |>
  rowwise() |>
  mutate(
    peak_pos = 4 + sin((line_id / n_lines) * 2 * pi),  
    x_points = list(seq(x_start, x_end, length.out = 5)),
    y_points = list(rep(y, 5)),
    alpha_val = list(pmax(0.1, 1 - abs(1:5 - peak_pos) / 2))
  ) |>
  unnest(c(x_points, y_points, alpha_val)) |>
  mutate(
    x = x_points * cos(angle) - y_points * sin(angle),
    y_new = x_points * sin(angle) + y_points * cos(angle)
  )

gradient_background <- ggplot(chord_data) +
  geom_link2(aes(x = x, y = y_new, alpha = alpha_val, group = line_id), 
             color = "#72ddf7", n = 500) +
  scale_alpha_identity() +
  coord_fixed() +
  theme_void() +
  theme(panel.background = element_rect(fill = "black"))


temp_file <- tempfile(fileext = ".png")
ggsave(temp_file, gradient_background, width = 4, height = 4, bg = "transparent", limitsize = FALSE)

```

And here's the plot with the gradient background:

```{r}
#gradient arc data
#how can we add the gradients?

#we need some way to place the gradient background inside the plot
#and then the last thing to figure out - cropping to a circle


#final plot
training_plot <- ggplot() +
coord_radial(
    start = 4/3 * pi,  # 240°
    end = 2/3 * pi,    # 120°
    expand = FALSE,
    rlim = c(0, .9)
  ) +
    geom_image(aes(x = 5, y = 0, image = temp_file), size = 1.2) +
    annotate(
    geom = "rect", 
    xmin = c(0, 2.5, 5, 7.5, 9.7), xmax = c(2.5, 5, 7.5, 9.7, 10),
    ymin = c(.97, .97,.97, .93, .97), ymax = 1,
    fill = c("#d00000", "#ff9100", "#70e000", "#72ddf7", "purple")
  ) +
    annotate(
        geom = "segment", 
        x = c(2.5, 5, 7.5, 9.7), xend = c(2.5, 5, 7.5, 9.7), 
        y = .93, yend = 1,
        linewidth = 1, color = "#101010"
      ) +
    annotate(
        geom = "segment", 
        x = 8.2, xend = 8.2,
        y = .88, yend = 1.02,
        size = 2, linewidth = 5, color = "#101010"
      ) +
    annotate(
        geom = "segment", 
        x = 8.2, xend = 8.2,
        y = .9, yend = 1,
        size = 2, linewidth = 3, color = "grey90"
      ) +
    annotate(
        geom = "text",
        x = 5,
        y = .65,
        label = "Training\nreadiness",
        color = "white",
        family = font,
        lineheight = .3,
        size = 70
    ) +
    annotate(
        geom = "text",
        x = 5,
        y = 0.1,
        label = 82,
        color = "white",
        family = font,
        size = 220
    ) +
    geom_text(
        aes(x = 5,
        y = 0,
        label = "High"),
        color = "#72ddf7",
        family = font,
        fontface = "italic",
        nudge_y = -.4,
        size = 70
    ) +
    geom_text(
        aes(x = 5,
        y = 0,
        label = "Well Recovered"),
        color = "white",
        family = font,
        nudge_y = -.6,
        size = 70
    ) +
labs(x = NULL, y = NULL) +
    theme_garmin() +
    theme(axis.text = element_blank(),
         plot.margin = margin(b = 320))


cropped_training_plot <- crop_to_circle(training_plot, 15, 15, 0, scale = 500, c("left" = 235, "top" = 230, "size" = 220))
cropped_training_plot
```

Here's how all the plots look together:

:::: {.columns}

::: {.column width="50%"}
```{r echo = FALSE}
cropped_sleep_plot
cropped_training_plot
```
:::

::: {.column width="50%"}
```{r echo = FALSE}
cropped_heart_plot
cropped_stress_plot
```
:::
::::

## Final thoughts

It was a lot more fun that I initially thought. The workload was pretty much 10% on making the basic versions of the plot and 90% on figuring out how to make the gradient background and crop the plots to circle. Especially the last part was tough as I needed to fit the sizes of the plots well.